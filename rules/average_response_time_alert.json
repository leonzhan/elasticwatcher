{
  "trigger": {
    "schedule": {
      "interval": "5m"
    }
  },
  "name": "average_response_time",
  "type": "aggregation_expected",
  "input": {
    "search": {
      "request": {
        "elastic_host": "localhost",
        "elastic_port": 9200,
        "indices": "mactest",
        "types": "cluster_state",
        "body": {
          "query": {
            "filtered": {
              "query": {
                "query_string": {
                  "query": "tag:*eshaproxy* AND NOT (http_verb:HEAD AND http_request:*timeout*)",
                  "analyze_wildcard": true
                }
              },
              "filter": {
                "bool": {
                  "must": [
                    {
                      "range": {
                        "@timestamp": {
                          "gte": "now-2m",
                          "lte": "now",
                          "format": "epoch_millis"
                        }
                      }
                    }
                  ],
                  "must_not": []
                }
              }
            }
          },
          "aggs": {
            "average_response_time": {
              "avg": {
                "field": "time_duration_tt"
              }
            }
          }
        }
      }
    }
  },
  "condition": {
    "date_histogram": true,
    "ignore_null": true,
    "compare_key": "average_response_time",
    "expected": 1000,
    "operator": "<="
  },
  "actions": {
    "pagerduty": { 
      "pagerduty_service_key": "6d831a19f9fa48db942cfd5ac8d69418",
      "pagerduty_client_name": "int-elastic-alert"
    }
  }
}